<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#f97316">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<title>Mustang PM Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Share+Tech+Mono&family=Barlow:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d0f10; --surface: #151719; --surface2: #1c1f22; --border: #2a2e32;
    --orange: #f97316; --orange-dim: #7c3a0e; --red: #ef4444; --red-dim: #450a0a;
    --yellow: #eab308; --yellow-dim: #422006; --green: #22c55e; --green-dim: #052e16;
    --blue: #3b82f6; --blue-dim: #1e3a5f;
    --text: #e2e8f0; --text-dim: #64748b; --text-mid: #94a3b8;
    --font-display: 'Rajdhani', sans-serif; --font-mono: 'Share Tech Mono', monospace; --font-body: 'Barlow', sans-serif;
  }
  body.light-mode {
    --bg: #f0f2f5; --surface: #ffffff; --surface2: #e8eaed; --border: #c8cdd4;
    --orange: #e06010; --orange-dim: #fde8d8; --red: #dc2626; --red-dim: #fee2e2;
    --yellow: #b45309; --yellow-dim: #fef9c3; --green: #16a34a; --green-dim: #dcfce7;
    --blue: #2563eb; --blue-dim: #dbeafe;
    --text: #1e2530; --text-dim: #64748b; --text-mid: #475569;
  }
  body.light-mode .task-card.overdue { background: #fee2e2; }
  body.light-mode .task-card.due-soon { background: #fef9c3; }
  body.light-mode .task-card.never-done { background: #fde8d8; }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  html { font-size: 15px; }
  body { background: var(--bg); color: var(--text); font-family: var(--font-body); min-height: 100vh; overflow-x: hidden; }

  .header { background: var(--surface); border-bottom: 2px solid var(--orange); padding: 0 16px; display: flex; align-items: center; justify-content: space-between; min-height: 60px; height: auto; padding-top: 8px; padding-bottom: 8px; position: sticky; top: 0; z-index: 100; gap: 8px; }
  .logo { font-family: var(--font-display); font-size: clamp(1.1rem, 4vw, 2rem); font-weight: 700; letter-spacing: 2px; color: var(--orange); text-transform: uppercase; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .logo span { color: var(--text-dim); font-weight: 400; }
  .header-right { display: flex; align-items: center; gap: 8px; }
  .overdue-badge { background: var(--red); color: white; font-family: var(--font-display); font-weight: 700; font-size: 0.9rem; padding: 3px 8px; border-radius: 2px; display: none; animation: pulse 2s infinite; }
  .sync-status { font-family: var(--font-mono); font-size: 0.7rem; padding: 3px 7px; border-radius: 2px; border: 1px solid var(--border); }
  .sync-status.synced { color: var(--green); border-color: var(--green-dim); background: var(--green-dim); }
  .sync-status.syncing { color: var(--yellow); border-color: var(--yellow-dim); background: var(--yellow-dim); }
  .sync-status.offline { color: var(--text-dim); border-color: var(--border); }
  .sync-status.error { color: var(--red); border-color: var(--red-dim); background: var(--red-dim); }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

  .device-bar { background: var(--surface2); border-bottom: 1px solid var(--border); padding: 8px 12px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
  .bar-btn { background: none; border: 1px solid var(--border); color: var(--text-dim); font-size: 1.2rem; width: 40px; height: 40px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; overflow: hidden; }
  .bar-btn:hover { border-color: var(--orange); color: var(--orange); }

  .machine-selector { background: var(--bg); border: 1px solid var(--border); color: var(--orange); padding: 6px 10px; font-family: var(--font-mono); font-size: 1rem; font-weight: 700; outline: none; flex: 1; min-width: 0; cursor: pointer; }
  .machine-selector:focus { border-color: var(--orange); }

  .tabs { display: flex; background: var(--surface); border-bottom: 1px solid var(--border); overflow-x: auto; scrollbar-width: none; }
  .tabs::-webkit-scrollbar { display: none; }
  .tab { font-family: var(--font-display); font-size: 1rem; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; padding: 12px 20px; border: none; background: none; color: var(--text-dim); cursor: pointer; white-space: nowrap; border-bottom: 2px solid transparent; transition: all 0.2s; }
  .tab.active { color: var(--orange); border-bottom-color: var(--orange); }
  .tab .tab-badge { background: var(--red); color: white; font-size: 0.6rem; padding: 1px 5px; border-radius: 10px; margin-left: 4px; display: none; }

  .stats-bar { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1px; background: var(--border); border-bottom: 1px solid var(--border); }
  .stat { background: var(--surface); padding: 10px 12px; text-align: center; cursor: pointer; }
  .stat:hover { background: var(--surface2); }
  .stat-val { font-family: var(--font-display); font-size: 2rem; font-weight: 700; line-height: 1; }
  .stat-label { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-dim); margin-top: 2px; }
  .stat-val.red { color: var(--red); } .stat-val.yellow { color: var(--yellow); } .stat-val.green { color: var(--green); } .stat-val.orange { color: var(--orange); }

  .task-list { padding: 12px; display: flex; flex-direction: column; gap: 8px; }
  .task-card { background: var(--surface); border: 1px solid var(--border); border-left: 3px solid var(--border); padding: 16px 18px; cursor: pointer; transition: all 0.15s; }
  .task-card:hover { background: var(--surface2); }
  .task-card.overdue { border-left-color: var(--red); background: #150a0a; }
  .task-card.due-soon { border-left-color: var(--yellow); background: #110f06; }
  .task-card.ok { border-left-color: var(--green); }
  .task-card.never-done { border-left-color: var(--orange); background: #110a04; }
  .task-top { display: flex; align-items: flex-start; justify-content: space-between; gap: 8px; }
  .task-name { font-family: var(--font-display); font-size: 1.25rem; font-weight: 600; letter-spacing: 0.5px; line-height: 1.2; flex: 1; }
  .task-freq { font-family: var(--font-mono); font-size: 0.95rem; color: var(--text-dim); background: var(--surface2); border: 1px solid var(--border); padding: 2px 8px; white-space: nowrap; flex-shrink: 0; }
  .task-bottom { display: flex; align-items: center; justify-content: space-between; margin-top: 8px; }
  .task-due { font-family: var(--font-mono); font-size: 1rem; }
  .task-due.red { color: var(--red); } .task-due.yellow { color: var(--yellow); } .task-due.green { color: var(--green); } .task-due.orange { color: var(--orange); }
  .task-status-tag { font-size: 0.75rem; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; padding: 2px 8px; border-radius: 1px; }
  .tag-overdue { background: var(--red-dim); color: var(--red); } .tag-soon { background: var(--yellow-dim); color: var(--yellow); } .tag-ok { background: var(--green-dim); color: var(--green); } .tag-pending { background: var(--orange-dim); color: var(--orange); }
  .history-count { font-family: var(--font-mono); font-size: 0.88rem; color: var(--text-dim); }
  .last-tech { font-family: var(--font-mono); font-size: 0.88rem; color: var(--text-mid); margin-top: 1px; }
  .task-note-badge { font-family: var(--font-mono); font-size: 0.85rem; color: var(--blue); background: var(--blue-dim); border: 1px solid var(--blue-dim); padding: 1px 6px; margin-top: 3px; display: inline-block; }
  .history-edit-btn { background: none; border: 1px solid var(--border); color: var(--text-dim); font-size: 0.85rem; padding: 2px 7px; cursor: pointer; font-family: var(--font-mono); float: right; margin-top: 2px; }
  .history-edit-btn:hover { border-color: var(--orange); color: var(--orange); }
  .tech-filter-bar { padding: 8px 12px; background: var(--surface2); border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 8px; }
  .tech-filter-bar select { background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 5px 8px; font-family: var(--font-mono); font-size: 0.85rem; outline: none; flex: 1; }
  .tech-filter-bar select:focus { border-color: var(--orange); }
  .tech-filter-label { font-family: var(--font-mono); font-size: 0.9rem; color: var(--text-dim); white-space: nowrap; }
  .btn-pdf { background: var(--red); color: white; }

  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 200; display: none; align-items: flex-end; justify-content: center; }
  .modal-overlay.open { display: flex; }
  .modal { background: var(--surface); border: 1px solid var(--border); border-top: 2px solid var(--orange); width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; animation: slideUp 0.25s ease; }
  @keyframes slideUp { from { transform: translateY(40px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  .modal-header { padding: 16px 16px 12px; border-bottom: 1px solid var(--border); display: flex; align-items: flex-start; justify-content: space-between; gap: 8px; }
  .modal-title { font-family: var(--font-display); font-size: 1.5rem; font-weight: 700; letter-spacing: 1px; flex: 1; }
  .modal-close { background: none; border: 1px solid var(--border); color: var(--text-dim); width: 32px; height: 32px; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
  .modal-body { padding: 16px; }
  .modal-info-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 1rem; }
  .modal-info-row:last-child { border-bottom: none; }
  .info-label { font-family: var(--font-mono); font-size: 0.85rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; }
  .info-value { font-family: var(--font-mono); font-size: 0.9rem; color: var(--text); }
  .section-title { font-family: var(--font-display); font-size: 0.95rem; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; color: var(--text-dim); margin: 16px 0 8px; border-bottom: 1px solid var(--border); padding-bottom: 4px; }
  .complete-form { background: var(--surface2); border: 1px solid var(--border); padding: 12px; margin-top: 8px; }
  .form-row { margin-bottom: 10px; }
  label { display: block; font-family: var(--font-mono); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-dim); margin-bottom: 4px; }
  input[type="date"], textarea, input[type="text"], input[type="number"], select.form-select { width: 100%; background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 10px 12px; font-family: var(--font-mono); font-size: 1rem; outline: none; transition: border-color 0.15s; }
  input[type="date"]:focus, textarea:focus, input[type="text"]:focus, input[type="number"]:focus, select.form-select:focus { border-color: var(--orange); }
  textarea { resize: vertical; min-height: 70px; }
  .btn-complete { width: 100%; background: var(--orange); color: #000; border: none; font-family: var(--font-display); font-size: 1.2rem; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; padding: 12px; cursor: pointer; transition: background 0.15s; margin-top: 4px; }
  .btn-complete:hover { background: #fb923c; }

  .history-entry { background: var(--surface2); border: 1px solid var(--border); border-left: 2px solid var(--green); padding: 8px 10px; margin-bottom: 6px; }
  .history-date { font-family: var(--font-mono); font-size: 0.85rem; color: var(--green); margin-bottom: 4px; }
  .history-tech { font-size: 0.9rem; color: var(--text-mid); margin-bottom: 2px; }
  .history-notes { font-size: 0.85rem; color: var(--text-dim); font-style: italic; }
  .no-history { font-family: var(--font-mono); font-size: 0.9rem; color: var(--text-dim); text-align: center; padding: 12px; }
  .freq-divider { font-family: var(--font-display); font-size: 0.85rem; font-weight: 600; letter-spacing: 3px; text-transform: uppercase; color: var(--text-dim); padding: 6px 4px 2px; border-bottom: 1px solid var(--border); margin-bottom: 4px; margin-top: 8px; }
  .empty-state { text-align: center; padding: 40px 20px; color: var(--text-dim); font-family: var(--font-mono); font-size: 0.92rem; }
  .next-due-preview { font-family: var(--font-mono); font-size: 0.85rem; color: var(--orange); margin-top: 6px; padding: 4px 8px; background: var(--orange-dim); border: 1px solid var(--orange-dim); }

  .data-panel { margin: 12px; background: var(--surface); border: 1px solid var(--border); border-top: 2px solid var(--blue); padding: 14px; }
  .data-panel-title { font-family: var(--font-display); font-size: 1rem; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; color: var(--blue); margin-bottom: 12px; }
  .data-btn-row { display: flex; gap: 8px; flex-wrap: wrap; }
  .btn-data { flex: 1; min-width: 120px; padding: 10px 14px; border: none; cursor: pointer; font-family: var(--font-display); font-size: 0.95rem; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; }
  .btn-export { background: var(--blue); color: white; }
  .btn-import { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .btn-cloud-save { background: var(--green); color: #000; }
  .btn-cloud-load { background: var(--surface2); color: var(--green); border: 1px solid var(--green-dim); }
  .data-note { font-family: var(--font-mono); font-size: 0.9rem; color: var(--text-dim); margin-top: 8px; line-height: 1.6; }

  .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: var(--surface2); border: 1px solid var(--border); color: var(--text); font-family: var(--font-mono); font-size: 0.85rem; padding: 10px 20px; z-index: 300; opacity: 0; transition: opacity 0.3s; white-space: nowrap; pointer-events: none; }
  .toast.show { opacity: 1; }
  .toast.success { border-color: var(--green); color: var(--green); }
  .toast.error { border-color: var(--red); color: var(--red); }

  @media print {
    body > *:not(#pdfOverlay) { display: none !important; }
    #pdfOverlay { position: static !important; overflow: visible !important; }
    #pdfOverlay > div:first-child { display: none !important; }
  }
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); }

  .manage-panel { padding: 12px; }
  .manage-section { background: var(--surface); border: 1px solid var(--border); border-top: 2px solid var(--orange); padding: 16px; margin-bottom: 12px; }
  .manage-section-title { font-family: var(--font-display); font-size: 1.1rem; font-weight: 700; letter-spacing: 1px; color: var(--orange); margin-bottom: 12px; }
  .custom-task-item { background: var(--surface2); border: 1px solid var(--border); border-left: 3px solid var(--orange); padding: 10px 12px; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; gap: 8px; }
  .custom-task-info { flex: 1; }
  .custom-task-name { font-family: var(--font-display); font-size: 1.05rem; font-weight: 600; }
  .custom-task-freq { font-family: var(--font-mono); font-size: 0.9rem; color: var(--text-dim); margin-top: 2px; }
  .custom-task-btns { display: flex; gap: 6px; flex-shrink: 0; }
  .btn-edit { background: var(--blue-dim); color: var(--blue); border: 1px solid var(--blue-dim); font-family: var(--font-display); font-weight: 700; font-size: 0.8rem; padding: 4px 10px; cursor: pointer; }
  .btn-del { background: var(--red-dim); color: var(--red); border: 1px solid var(--red-dim); font-family: var(--font-display); font-weight: 700; font-size: 0.8rem; padding: 4px 10px; cursor: pointer; }
  .add-pm-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.88); z-index: 400; align-items: flex-end; justify-content: center; }
  .add-pm-overlay.open { display: flex; }
  .add-pm-sheet { background: var(--surface); border-top: 2px solid var(--orange); width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
  .add-pm-header { padding: 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
  .add-pm-title { font-family: var(--font-display); font-size: 1.3rem; font-weight: 700; letter-spacing: 1px; }
  .add-pm-body { padding: 16px; }
  .freq-preview { font-family: var(--font-mono); font-size: 0.85rem; color: var(--orange); background: var(--orange-dim); border: 1px solid var(--orange-dim); padding: 8px 10px; margin: 8px 0 14px; }

  .machine-item { background: var(--surface2); border: 1px solid var(--border); border-left: 3px solid var(--green); padding: 12px 14px; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; gap: 8px; }
  .machine-item.active-machine { border-left-color: var(--orange); background: var(--orange-dim); }
  .machine-item-name { font-family: var(--font-display); font-size: 1.1rem; font-weight: 600; flex: 1; }
  .machine-item-count { font-family: var(--font-mono); font-size: 0.85rem; color: var(--text-dim); }
  .builtin-label { font-family: var(--font-mono); font-size: 0.7rem; color: var(--text-dim); background: var(--surface); border: 1px solid var(--border); padding: 1px 5px; margin-left: 6px; }
</style>
</head>
<body>

<div class="header">
  <div class="logo">Mustang <span>PM Tracker</span></div>
  <div class="header-right">
    <div class="sync-status offline" id="syncStatus">OFFLINE</div>
    <div class="overdue-badge" id="globalOverdueBadge">0 OVERDUE</div>
  </div>
</div>

<div class="device-bar">
  <select class="machine-selector" id="machineSelect" onchange="switchMachine()"></select>
  <button class="bar-btn" onclick="openMachineModal(allData.activeMachine)" title="Rename machine" style="font-size:0.9rem;">‚úé</button>
  <button onclick="openAddPMModal()" style="background:var(--orange);color:#000;border:none;font-family:var(--font-display);font-weight:700;font-size:0.8rem;padding:5px 10px;cursor:pointer;white-space:nowrap;">+ ADD PM</button>
  <button class="bar-btn" id="lightToggleBtn" onclick="toggleLightMode()">‚òÄ</button>
  <button class="bar-btn" id="fontSizeBtn" onclick="cycleFontSize()">ùêÄ</button>
  <button class="bar-btn" id="updateBtn" onclick="checkForUpdate()" title="Check for update, then pull down to refresh">‚Üª</button>
</div>

<div class="tabs">
  <button class="tab active" onclick="setTab('all')" id="tab-all">All Tasks</button>
  <button class="tab" onclick="setTab('overdue')" id="tab-overdue">Overdue <span class="tab-badge" id="badge-overdue"></span></button>
  <button class="tab" onclick="setTab('due-soon')" id="tab-due-soon">Due Soon <span class="tab-badge" id="badge-soon"></span></button>
  <button class="tab" onclick="setTab('by-date')" id="tab-by-date">By Due Date</button>
  <button class="tab" onclick="setTab('history')" id="tab-history">History</button>
  <button class="tab" onclick="setTab('manage')" id="tab-manage">‚öô Manage</button>
  <button class="tab" onclick="setTab('data')" id="tab-data">üíæ Backup</button>
  <button id="tab-ok" style="display:none"></button>
  <button id="tab-pending" style="display:none"></button>
  <button id="tab-all-sorted" style="display:none"></button>
</div>

<div class="stats-bar">
  <div class="stat" onclick="setTab('overdue')"><div class="stat-val red" id="stat-overdue">0</div><div class="stat-label">Overdue</div></div>
  <div class="stat" onclick="setTab('due-soon')"><div class="stat-val yellow" id="stat-soon">0</div><div class="stat-label">Due Soon</div></div>
  <div class="stat" onclick="setTab('ok')"><div class="stat-val green" id="stat-ok">0</div><div class="stat-label">On Track</div></div>
  <div class="stat" onclick="setTab('all-sorted')"><div class="stat-val orange" id="stat-pending">0</div><div class="stat-label">Simple View</div></div>
</div>

<div class="task-list" id="taskList"></div>
<div id="techFilterBar" class="tech-filter-bar" style="display:none;">
  <span class="tech-filter-label">FILTER BY TECH:</span>
  <select id="techFilterSelect" onchange="renderHistory()">
    <option value="">All Technicians</option>
  </select>
</div>
<div class="task-list" id="historyList" style="display:none;"></div>

<div id="dataPanel" style="display:none;">
  <div class="data-panel">
    <div class="data-panel-title">‚Ñπ About</div>
    <div style="font-family:var(--font-mono);font-size:0.9rem;line-height:1.8;color:var(--text-mid);">
      <div style="font-family:var(--font-display);font-size:1.3rem;font-weight:700;color:var(--orange);letter-spacing:1px;margin-bottom:6px;">MUSTANG PM TRACKER</div>
      <div>Developed for the <span style="color:var(--text);">Coatings Department</span></div>
      <div>Built by <span style="color:var(--text);">Nick Terry</span></div>
      <div style="margin-top:10px;">Questions or comments? <a href="mailto:NALTroubleshooting@gmail.com" style="color:var(--orange);text-decoration:none;">NALTroubleshooting@gmail.com</a></div>
      <div style="margin-top:12px;display:flex;flex-direction:column;gap:8px;">
        <button onclick="checkForUpdate()" style="width:100%;background:var(--blue);color:#fff;border:none;font-family:var(--font-display);font-weight:700;font-size:1rem;letter-spacing:1px;padding:10px;cursor:pointer;">‚Üª CHECK FOR UPDATE</button>
        <button onclick="shareApp()" style="width:100%;background:var(--surface2);color:var(--text);border:1px solid var(--border);font-family:var(--font-display);font-weight:700;font-size:1rem;letter-spacing:1px;padding:10px;cursor:pointer;">üîó COPY APP LINK</button>
      </div>
    </div>
  </div>
  <div class="data-panel">
    <div class="data-panel-title">üìÑ PDF Report</div>
    <div class="data-btn-row">
      <button class="btn-data btn-pdf" onclick="exportPDF()">üñ® Print / Save as PDF</button>
    </div>
    <div class="data-note">Opens a printable completion history report for the current machine.</div>
  </div>
  <div class="data-panel">
    <div class="data-panel-title">‚òÅ Cloud Backup</div>
    <div class="data-btn-row">
      <button class="btn-data btn-cloud-save" onclick="openPinModal('set')">‚¨Ü Save to Cloud</button>
      <button class="btn-data btn-cloud-load" onclick="openPinModal('load')">‚¨á Load from Cloud</button>
    </div>
    <div class="data-note">Set a 4-digit PIN to save your data. Enter that PIN on any device to restore it.</div>
  </div>
  <div class="data-panel">
    <div class="data-panel-title">üìÅ Local File Backup</div>
    <div class="data-btn-row">
      <button class="btn-data btn-export" onclick="exportData()">‚¨á Export to File</button>
      <button class="btn-data btn-import" onclick="document.getElementById('importFile').click()">‚¨Ü Import from File</button>
    </div>
    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
    <div class="data-note">Export saves a .json backup of ALL machines. Import restores from that file.</div>
  </div>
</div>

<!-- Task Detail / Completion Modal -->
<div class="modal-overlay" id="modalOverlay" onclick="handleOverlayClick(event)">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modalTitle"></div>
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="modalInfo"></div>
      <div class="section-title">‚Äî Log Completion ‚Äî</div>
      <div class="complete-form">
        <div class="form-row"><label>Completed On (date)</label><input type="date" id="completionDate"></div>
        <div class="form-row"><label>Technician Name</label><input type="text" id="techName" placeholder="Enter your name"></div>
        <div class="form-row"><label>Notes (optional)</label><textarea id="completionNotes" placeholder="Any observations, issues, or comments..."></textarea></div>
        <div class="next-due-preview" id="nextDuePreview" style="display:none;"></div>
        <button class="btn-complete" onclick="logCompletion()">‚úì Mark Complete &amp; Reschedule</button>
      </div>
      <div class="section-title">‚Äî Completion History ‚Äî</div>
      <div id="historyEntries"></div>
    </div>
  </div>
</div>

<!-- Manage Panel (machines + PMs + notes) -->
<div id="managePanel" style="display:none;">
  <div class="manage-panel">
    <!-- Machines Section -->
    <div class="manage-section">
      <div class="manage-section-title">üè≠ Machines</div>
      <button onclick="openMachineModal()" style="width:100%;background:var(--orange);color:#000;border:none;font-family:var(--font-display);font-size:1.1rem;font-weight:700;letter-spacing:1px;padding:11px;cursor:pointer;margin-bottom:12px;">‚ûï ADD NEW MACHINE</button>
      <div id="machineList"></div>
    </div>
    <!-- All PM Tasks Section -->
    <div class="manage-section">
      <div class="manage-section-title">üìã PM Tasks ‚Äî <span id="manageMachineName"></span></div>
      <button onclick="openAddPMModal(null)" style="width:100%;background:var(--orange);color:#000;border:none;font-family:var(--font-display);font-size:1.1rem;font-weight:700;letter-spacing:1px;padding:11px;cursor:pointer;margin-bottom:12px;">‚ûï ADD NEW PM TASK</button>
      <div id="allTaskList"></div>
    </div>
    <!-- Task Notes Section -->
    <div class="manage-section">
      <div class="manage-section-title">üìù Task Notes</div>
      <div style="font-family:var(--font-mono);font-size:0.8rem;color:var(--text-dim);margin-bottom:10px;">Add a permanent note to any task (e.g. "Use Mobil oil only"). Shown on the task card.</div>
      <div class="form-row">
        <label>Select Task</label>
        <select id="noteTaskSelect" class="form-select" onchange="loadTaskNote()"></select>
      </div>
      <div class="form-row">
        <label>Note</label>
        <textarea id="noteTextarea" placeholder="e.g. Use Mobil 1 oil only. Check torque spec on manual p.12."></textarea>
      </div>
      <button onclick="saveTaskNote()" style="width:100%;background:var(--blue);color:white;border:none;font-family:var(--font-display);font-size:1.1rem;font-weight:700;letter-spacing:1px;padding:10px;cursor:pointer;">‚úì SAVE NOTE</button>
    </div>
  </div>
</div>

<!-- Add/Edit PM Task Overlay -->
<div class="add-pm-overlay" id="addPMOverlay" onclick="handleAddPMClick(event)">
  <div class="add-pm-sheet">
    <div class="add-pm-header">
      <div class="add-pm-title" id="addPMTitle">ADD NEW PM TASK</div>
      <button onclick="closeAddPMModal()" style="background:none;border:1px solid var(--border);color:var(--text-dim);width:32px;height:32px;font-size:1.1rem;cursor:pointer;">‚úï</button>
    </div>
    <div class="add-pm-body">
      <div class="form-row"><label>Task Name</label><input type="text" id="pmName" maxlength="80" placeholder="e.g. Grease Main Bearings"></div>
      <div class="form-row">
        <label>Frequency Type</label>
        <select id="pmFreqType" class="form-select" onchange="updatePMPreview()">
          <option value="d">Every X Days</option>
          <option value="w">Every X Weeks</option>
          <option value="mo">Every X Months</option>
          <option value="y">Every X Years</option>
        </select>
      </div>
      <div class="form-row"><label id="pmAmountLabel">How many days?</label><input type="number" id="pmAmount" min="1" max="999" value="30" oninput="updatePMPreview()"></div>
      <div class="freq-preview" id="pmPreview">‚Üí Repeats every 30 days</div>
      <input type="hidden" id="pmEditId">
      <input type="hidden" id="pmEditType">
      <button onclick="saveCustomPM()" style="width:100%;background:var(--orange);color:#000;border:none;font-family:var(--font-display);font-size:1.2rem;font-weight:700;letter-spacing:2px;padding:12px;cursor:pointer;">‚úì SAVE TASK</button>
    </div>
  </div>
</div>

<!-- Add/Edit Machine Modal -->
<div id="machineModalOverlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:300;align-items:center;justify-content:center;" onclick="if(event.target===this)closeMachineModal()">
  <div style="background:var(--surface);border:1px solid var(--border);border-top:2px solid var(--orange);width:90%;max-width:400px;padding:20px;">
    <div style="font-family:var(--font-display);font-size:1.3rem;font-weight:700;letter-spacing:1px;margin-bottom:16px;" id="machineModalTitle">ADD MACHINE</div>
    <input type="text" id="machineNameInput" maxlength="30" placeholder="e.g. MOPM3 or Mustang 1" style="margin-bottom:12px;">
    <input type="hidden" id="machineEditId">
    <div style="display:flex;gap:8px;">
      <button onclick="saveMachine()" style="flex:1;background:var(--orange);color:#000;border:none;font-family:var(--font-display);font-size:1.1rem;font-weight:700;padding:10px;cursor:pointer;">SAVE</button>
      <button onclick="closeMachineModal()" style="flex:1;background:var(--surface2);color:var(--text);border:1px solid var(--border);font-family:var(--font-display);font-size:1.1rem;font-weight:700;padding:10px;cursor:pointer;">CANCEL</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- PIN Modal -->
<div id="pinModalOverlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.88);z-index:400;align-items:center;justify-content:center;" onclick="if(event.target===this)closePinModal()">
  <div style="background:var(--surface);border:1px solid var(--border);border-top:3px solid var(--orange);width:90%;max-width:360px;padding:24px;">
    <div style="font-family:var(--font-display);font-size:1.4rem;font-weight:700;letter-spacing:1px;color:var(--orange);margin-bottom:8px;" id="pinModalTitle"></div>
    <div style="font-family:var(--font-body);font-size:0.9rem;color:var(--text-mid);margin-bottom:20px;" id="pinModalSubtitle"></div>
    <div style="margin-bottom:12px;">
      <label style="font-family:var(--font-mono);font-size:0.8rem;color:var(--text-dim);display:block;margin-bottom:4px;">PIN</label>
      <input id="pinInput" type="number" placeholder="0000" inputmode="numeric"
        style="width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:var(--font-mono);font-size:2rem;font-weight:700;padding:10px;text-align:center;letter-spacing:8px;outline:none;"
        oninput="if(this.value.length>4)this.value=this.value.slice(0,4)">
    </div>
    <div id="pinConfirmRow" style="margin-bottom:12px;display:none;">
      <label style="font-family:var(--font-mono);font-size:0.8rem;color:var(--text-dim);display:block;margin-bottom:4px;">CONFIRM PIN</label>
      <input id="pinConfirmInput" type="number" placeholder="0000" inputmode="numeric"
        style="width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:var(--font-mono);font-size:2rem;font-weight:700;padding:10px;text-align:center;letter-spacing:8px;outline:none;"
        oninput="if(this.value.length>4)this.value=this.value.slice(0,4)">
    </div>
    <div id="pinError" style="font-family:var(--font-mono);font-size:0.85rem;color:var(--red);min-height:20px;margin-bottom:12px;"></div>
    <button id="pinModalBtn" style="width:100%;background:var(--orange);color:#000;border:none;font-family:var(--font-display);font-size:1.1rem;font-weight:700;letter-spacing:1px;padding:12px;cursor:pointer;margin-bottom:8px;"></button>
    <button onclick="closePinModal()" style="width:100%;background:none;border:1px solid var(--border);color:var(--text-dim);font-family:var(--font-display);font-size:1rem;font-weight:600;padding:10px;cursor:pointer;">CANCEL</button>
  </div>
</div>

<!-- PDF Report Overlay -->
<div id="pdfOverlay" style="display:none;position:fixed;inset:0;background:#fff;z-index:600;overflow-y:auto;">
  <div style="background:#f97316;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;">
    <div style="font-family:Arial,sans-serif;font-size:1.1rem;font-weight:bold;color:#000;">PM Completion Report</div>
    <div style="display:flex;gap:8px;">
      <button onclick="window.print()" style="background:#000;color:#fff;border:none;padding:8px 14px;font-size:0.95rem;cursor:pointer;font-weight:bold;">üñ® Print</button>
      <button onclick="closePDFOverlay()" style="background:none;border:2px solid #000;color:#000;width:36px;height:36px;font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center;">‚úï</button>
    </div>
  </div>
  <div id="pdfContent" style="padding:16px;font-family:Arial,sans-serif;color:#111;"></div>
</div>

<!-- Install Prompt -->
<div id="installPrompt" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.88);z-index:500;align-items:flex-end;justify-content:center;">
  <div style="background:var(--surface);border-top:2px solid var(--orange);width:100%;max-width:600px;padding:20px;animation:slideUp 0.3s ease;">
    <div style="font-family:var(--font-display);font-size:1.4rem;font-weight:700;letter-spacing:1px;color:var(--orange);margin-bottom:6px;">üì± INSTALL THIS APP</div>
    <div style="font-family:var(--font-body);font-size:0.95rem;color:var(--text-mid);margin-bottom:16px;">For the best experience, add this app to your home screen:</div>
    <div style="font-family:var(--font-mono);font-size:0.92rem;color:var(--text);line-height:2.2;">
      <div>1. Tap the <span style="color:var(--orange);font-weight:700;">‚ãÆ three dots</span> menu in Chrome</div>
      <div>2. Tap <span style="color:var(--orange);font-weight:700;">"Add to Home Screen"</span></div>
      <div>3. Tap <span style="color:var(--orange);font-weight:700;">"Install"</span></div>
    </div>
    <div style="font-family:var(--font-mono);font-size:0.88rem;color:var(--text-dim);margin-top:12px;margin-bottom:16px;">This allows the app to work offline and feel like a native app.</div>
    <button onclick="dismissInstallPrompt()" style="width:100%;background:var(--orange);color:#000;border:none;font-family:var(--font-display);font-size:1.1rem;font-weight:700;letter-spacing:1px;padding:12px;cursor:pointer;">‚úì GOT IT, DON'T SHOW AGAIN</button>
  </div>
</div>

<!-- Edit Completion Modal -->
<div class="modal-overlay" id="editCompOverlay" onclick="if(event.target===this)closeEditComp()" style="z-index:250;">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">EDIT COMPLETION</div>
      <button class="modal-close" onclick="closeEditComp()">‚úï</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="editCompTaskId">
      <input type="hidden" id="editCompIndex">
      <div class="form-row"><label>Completed On (date)</label><input type="date" id="editCompDate"></div>
      <div class="form-row"><label>Technician Name</label><input type="text" id="editCompTech" placeholder="Enter name"></div>
      <div class="form-row"><label>Notes (optional)</label><textarea id="editCompNotes" placeholder="Any observations..."></textarea></div>
      <button class="btn-complete" onclick="saveEditComp()">‚úì SAVE CHANGES</button>
    </div>
  </div>
</div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// ‚îÄ‚îÄ Default Tasks ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const TASKS_DEFAULT = [
  { id: 1,  name: "Check and Fill All Oil Lubricators",                  freq: "1w",  freqLabel: "1 Week"   },
  { id: 2,  name: "Check Control Panel Light Bulbs and Replace as Necessary", freq: "1w", freqLabel: "1 Week" },
  { id: 3,  name: "Inspect and Clean Glow Rod Feedthrus",                freq: "1w",  freqLabel: "1 Week"   },
  { id: 4,  name: "Check for Buildup Between Cathode Body and Chamber Wall", freq: "1w", freqLabel: "1 Week" },
  { id: 5,  name: "Check Color of Diffusion Pump Oil",                   freq: "1m",  freqLabel: "1 Month"  },
  { id: 6,  name: "Leak Check and Repair Any Leaks",                     freq: "1m",  freqLabel: "1 Month"  },
  { id: 7,  name: "Clean Electrical Control Cabinet Filter",              freq: "2m",  freqLabel: "2 Months" },
  { id: 8,  name: "Clean Chiller Supply Water Filter",                   freq: "2m",  freqLabel: "2 Months" },
  { id: 9,  name: "Remove, Clean, and Lubricate Vent Valve Piston",      freq: "2m",  freqLabel: "2 Months" },
  { id: 10, name: "Clean and Calibrate Chamber Gauge",                   freq: "3m",  freqLabel: "3 Months" },
  { id: 11, name: "Clean and Calibrate Foreline Gauge",                  freq: "3m",  freqLabel: "3 Months" },
  { id: 12, name: "Clean and Calibrate Roughing Line Gauge",             freq: "3m",  freqLabel: "3 Months" },
  { id: 13, name: "Lubricate Door Ball Screw",                           freq: "3m",  freqLabel: "3 Months" },
  { id: 14, name: "Replace Door Seal",                                   freq: "6m",  freqLabel: "6 Months" },
  { id: 15, name: "Replace High Vac Cylinder Seal",                      freq: "6m",  freqLabel: "6 Months" },
  { id: 16, name: "Replace Seal on Poppet Cylinder Shaft",               freq: "6m",  freqLabel: "6 Months" },
  { id: 17, name: "Change Demist Filters",                               freq: "1y",  freqLabel: "1 Year"   },
  { id: 18, name: "Check Belt Tension on Mechanical Pumps",              freq: "1y",  freqLabel: "1 Year"   },
  { id: 19, name: "Check Bushings to Ensure Belt Pulleys Have Not Moved on Mechanical Pumps", freq: "1y", freqLabel: "1 Year" },
];

const TASKS_VTI2 = [
  { id: 'vti2_1',  name: "Oil Level on Diffusion Pump ‚Äî Check at Hot Level Mark", freq: "1w",  freqLabel: "1 Week"   },
  { id: 'vti2_2',  name: "Change Water Filter",                                   freq: "1w",  freqLabel: "1 Week"   },
  { id: 'vti2_3',  name: "Check for Air Leaks (Repair as Needed)",                freq: "1w",  freqLabel: "1 Week"   },
  { id: 'vti2_4',  name: "Perform Leak Check with Leak Detector",                 freq: "1mo", freqLabel: "1 Month"  },
  { id: 'vti2_5',  name: "Grease Pump Motors",                                    freq: "1mo", freqLabel: "1 Month"  },
  { id: 'vti2_6',  name: "Check Safety Latch Pins ‚Äî 2 Locations, Both Doors, Total of 4 ‚Äî Not Worn, Bent, or Broken, Replace as Needed", freq: "1mo", freqLabel: "1 Month" },
  { id: 'vti2_7',  name: "Check Gears on Both Doors and Inside Chamber for Wear ‚Äî Replace as Needed", freq: "1mo", freqLabel: "1 Month" },
  { id: 'vti2_8',  name: "Replace High-Vac Cylinder Seal",                        freq: "2mo", freqLabel: "2 Months" },
  { id: 'vti2_9',  name: "Replace Roughing Valve Seal",                           freq: "3mo", freqLabel: "3 Months" },
  { id: 'vti2_10', name: "6S All Electrical Cabinets",                            freq: "6mo", freqLabel: "6 Months" },
  { id: 'vti2_11', name: "Rebuild Diffusion Pump",                                freq: "6mo", freqLabel: "6 Months" },
  { id: 'vti2_12', name: "Check Air Dryer Filter",                                freq: "1y",  freqLabel: "1 Year"   },
  { id: 'vti2_13', name: "Acidize Cooling Water Lines",                           freq: "1y",  freqLabel: "1 Year"   },
  { id: 'vti2_14', name: "Check Belt Tension on Mechanical Pumps",                freq: "1y",  freqLabel: "1 Year"   },
  { id: 'vti2_15', name: "Check that Pulleys Have Not Moved on Mechanical Pumps", freq: "1y",  freqLabel: "1 Year"   },
  { id: 'vti2_16', name: "Change Demist Filters",                                 freq: "1y",  freqLabel: "1 Year"   },
];

const TASKS_VTI4 = [
  { id: 'vti4_1',  name: "Oil Level on Diffusion Pump ‚Äî Check at Hot Level Mark", freq: "1w",  freqLabel: "1 Week"   },
  { id: 'vti4_2',  name: "Change Water Filter",                                   freq: "1w",  freqLabel: "1 Week"   },
  { id: 'vti4_3',  name: "Check for Air Leaks (Repair as Needed)",                freq: "1w",  freqLabel: "1 Week"   },
  { id: 'vti4_4',  name: "Perform Leak Check with Leak Detector",                 freq: "1mo", freqLabel: "1 Month"  },
  { id: 'vti4_5',  name: "Check Safety Latch Pins ‚Äî 2 Locations, Both Doors, Total of 4 ‚Äî Not Worn, Bent, or Broken, Replace as Needed", freq: "1mo", freqLabel: "1 Month" },
  { id: 'vti4_6',  name: "Check Gears on Both Doors and Inside Chamber for Wear ‚Äî Replace as Needed", freq: "1mo", freqLabel: "1 Month" },
  { id: 'vti4_7',  name: "Replace High-Vac Cylinder Seal",                        freq: "2mo", freqLabel: "2 Months" },
  { id: 'vti4_8',  name: "Replace Roughing Valve Seal",                           freq: "3mo", freqLabel: "3 Months" },
  { id: 'vti4_9',  name: "6S All Electrical Cabinets",                            freq: "6mo", freqLabel: "6 Months" },
  { id: 'vti4_10', name: "Rebuild Diffusion Pump",                                freq: "6mo", freqLabel: "6 Months" },
  { id: 'vti4_11', name: "Check Air Dryer Filter",                                freq: "1y",  freqLabel: "1 Year"   },
  { id: 'vti4_12', name: "Acidize Cooling Water Lines",                           freq: "1y",  freqLabel: "1 Year"   },
  { id: 'vti4_13', name: "Check Belt Tension on Mechanical Pumps",                freq: "1y",  freqLabel: "1 Year"   },
  { id: 'vti4_14', name: "Check that Pulleys Have Not Moved on Mechanical Pumps", freq: "1y",  freqLabel: "1 Year"   },
  { id: 'vti4_15', name: "Change Demist Filters",                                 freq: "1y",  freqLabel: "1 Year"   },
];

const MACHINE_TASKS = {
  'mach_default': TASKS_DEFAULT,
  'mach_vti2':    TASKS_VTI2,
  'mach_vti4':    TASKS_VTI4,
};

// ‚îÄ‚îÄ Multi-Machine Data Layer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Data structure in localStorage('mustangpm_alldata'):
// { machines: [{id, name}], activeMachine: 'id', machineData: { 'id': { state: {}, notes: {}, custom: [] } } }

function loadAllData() {
  try {
    const raw = localStorage.getItem('mustangpm_alldata');
    if (raw) return JSON.parse(raw);
  } catch(e) {}
  // Try migrating old single-machine data
  return migrateOldData();
}

function migrateOldData() {
  const oldState = (() => { try { const r = localStorage.getItem('mustangpm_state'); return r ? JSON.parse(r) : {}; } catch(e) { return {}; } })();
  const oldNotes = (() => { try { return JSON.parse(localStorage.getItem('mustangpm_notes') || '{}'); } catch(e) { return {}; } })();
  const oldCustom = (() => { try { return JSON.parse(localStorage.getItem('mustangpm_custom') || '[]'); } catch(e) { return []; } })();
  const oldName = localStorage.getItem('mustangpm_machinename') || 'Mustang';
  const hasOldData = Object.keys(oldState).length > 0 || oldCustom.length > 0;
  return {
    machines: [
      { id: 'mach_default', name: hasOldData ? oldName : 'Mustang' },
      { id: 'mach_vti2',    name: 'VTI 2' },
      { id: 'mach_vti4',    name: 'VTI 4' },
    ],
    activeMachine: 'mach_default',
    machineData: {
      'mach_default': { state: oldState, notes: oldNotes, custom: oldCustom },
      'mach_vti2':    { state: {}, notes: {}, custom: [] },
      'mach_vti4':    { state: {}, notes: {}, custom: [] },
    }
  };
}

function saveAllData() {
  localStorage.setItem('mustangpm_alldata', JSON.stringify(allData));
}

let allData = loadAllData();

// Active machine shortcuts
function getActiveMachineData() {
  const id = allData.activeMachine;
  if (!allData.machineData[id]) allData.machineData[id] = { state: {}, notes: {}, custom: [] };
  return allData.machineData[id];
}
function getState() { return getActiveMachineData().state; }
function getCustomTasks() { return getActiveMachineData().custom; }
function getNotes() { return getActiveMachineData().notes; }
function getActiveMachineName() {
  const m = allData.machines.find(m => m.id === allData.activeMachine);
  return m ? m.name : 'Unknown';
}

function getDefaultTasksForMachine(machineId) {
  return MACHINE_TASKS[machineId] || TASKS_DEFAULT;
}

function getAllTasks() { return [...getDefaultTasksForMachine(allData.activeMachine), ...getCustomTasks()]; }

// Ensure VTI 2 and VTI 4 exist for users who already have saved data
function ensureVti4Machine() {
  let changed = false;
  if (!allData.machines.find(m => m.id === 'mach_vti2')) {
    allData.machines.push({ id: 'mach_vti2', name: 'VTI 2' });
    allData.machineData['mach_vti2'] = { state: {}, notes: {}, custom: [] };
    changed = true;
  }
  if (!allData.machines.find(m => m.id === 'mach_vti4')) {
    allData.machines.push({ id: 'mach_vti4', name: 'VTI 4' });
    allData.machineData['mach_vti4'] = { state: {}, notes: {}, custom: [] };
    changed = true;
  }
  if (changed) saveAllData();
}
ensureVti4Machine();

let currentTab = 'all';
let currentTaskId = null;

// ‚îÄ‚îÄ Device ID ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadDeviceId() {
  return localStorage.getItem('mustangpm_deviceid') || null;
}
let deviceId = loadDeviceId();

function openPinModal(mode) {
  const overlay = document.getElementById('pinModalOverlay');
  const title = document.getElementById('pinModalTitle');
  const subtitle = document.getElementById('pinModalSubtitle');
  const confirmRow = document.getElementById('pinConfirmRow');
  const btn = document.getElementById('pinModalBtn');
  if (mode === 'set') {
    title.textContent = 'SET YOUR 4-DIGIT PIN';
    subtitle.textContent = 'This PIN lets you restore your data on any device. Write it down!';
    confirmRow.style.display = 'block';
    btn.textContent = 'SET PIN & SAVE TO CLOUD';
    btn.onclick = () => confirmSetPin();
  } else {
    title.textContent = 'ENTER YOUR 4-DIGIT PIN';
    subtitle.textContent = 'Enter the PIN you set when saving to restore your data.';
    confirmRow.style.display = 'none';
    btn.textContent = 'LOAD FROM CLOUD';
    btn.onclick = () => confirmLoadPin();
  }
  document.getElementById('pinInput').value = '';
  document.getElementById('pinConfirmInput').value = '';
  document.getElementById('pinError').textContent = '';
  overlay.style.display = 'flex';
}
function closePinModal() {
  document.getElementById('pinModalOverlay').style.display = 'none';
}
function confirmSetPin() {
  const pin = document.getElementById('pinInput').value.trim();
  const confirm = document.getElementById('pinConfirmInput').value.trim();
  const err = document.getElementById('pinError');
  if (!/^\d{4}$/.test(pin)) { err.textContent = 'PIN must be exactly 4 digits.'; return; }
  if (pin !== confirm) { err.textContent = 'PINs do not match. Try again.'; return; }
  deviceId = pin;
  localStorage.setItem('mustangpm_deviceid', pin);
  closePinModal();
  cloudSave();
}
function confirmLoadPin() {
  const pin = document.getElementById('pinInput').value.trim();
  const err = document.getElementById('pinError');
  if (!/^\d{4}$/.test(pin)) { err.textContent = 'PIN must be exactly 4 digits.'; return; }
  deviceId = pin;
  localStorage.setItem('mustangpm_deviceid', pin);
  closePinModal();
  cloudLoad();
}

// ‚îÄ‚îÄ Utilities ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function esc(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

function showToast(msg, type = '') {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = 'toast show ' + type;
  setTimeout(() => { t.className = 'toast'; }, 3000);
}

function setSyncStatus(type, label) {
  const el = document.getElementById('syncStatus');
  el.className = 'sync-status ' + type; el.textContent = label;
}

function today() { return new Date().toISOString().slice(0, 10); }
function dateFromStr(s) { const [y, m, d] = s.split('-').map(Number); return new Date(y, m - 1, d); }
function strFromDate(d) { return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0'); }

function calcNextDue(fromDateStr, freq) {
  if (/^\d+(d|w|mo|y)$/.test(freq)) return calcNextDueCustom(fromDateStr, freq);
  const d = dateFromStr(fromDateStr); const day = d.getDate(); let y = d.getFullYear(); let m = d.getMonth();
  if (freq === '1w') { d.setDate(day + 7); return strFromDate(d); }
  const addMonths = (n) => { m += n; if (m > 11) { y += Math.floor(m/12); m = m % 12; } const mx = new Date(y, m + 1, 0).getDate(); return `${y}-${String(m+1).padStart(2,'0')}-${String(Math.min(day, mx)).padStart(2,'0')}`; };
  if (freq === '1m') return addMonths(1);
  if (freq === '2m') return addMonths(2);
  if (freq === '3m') return addMonths(3);
  if (freq === '6m') return addMonths(6);
  if (freq === '1y') { y += 1; const mx = new Date(y, m + 1, 0).getDate(); return `${y}-${String(m+1).padStart(2,'0')}-${String(Math.min(day, mx)).padStart(2,'0')}`; }
  return fromDateStr;
}

function calcNextDueCustom(fromDateStr, freq) {
  const m = freq.match(/^(\d+)(d|w|mo|y)$/);
  if (!m) return fromDateStr;
  const n = parseInt(m[1]), t = m[2];
  const d = dateFromStr(fromDateStr);
  if (t==='d') { d.setDate(d.getDate()+n); }
  else if (t==='w') { d.setDate(d.getDate()+n*7); }
  else if (t==='mo') { d.setMonth(d.getMonth()+n); }
  else if (t==='y') { d.setFullYear(d.getFullYear()+n); }
  return strFromDate(d);
}

function daysDiff(dateStr) { return Math.round((dateFromStr(dateStr) - dateFromStr(today())) / 86400000); }

function formatDate(dateStr) {
  const [y, m, d] = dateStr.split('-');
  return ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][parseInt(m)-1] + ' ' + parseInt(d) + ', ' + y;
}

function freqTotalDays(freq) {
  if (freq==='1w') return 7; if (freq==='1m') return 30; if (freq==='2m') return 60;
  if (freq==='3m') return 90; if (freq==='6m') return 180; if (freq==='1y') return 365;
  const m = freq.match(/^(\d+)(d|w|mo|y)$/);
  if (!m) return 30;
  const n=parseInt(m[1]),t=m[2];
  if (t==='d') return n; if (t==='w') return n*7; if (t==='mo') return n*30; if (t==='y') return n*365;
  return 30;
}

function getStatus(task) {
  const state = getState();
  const ts = state[task.id]; if (!ts || !ts.nextDue) return 'pending';
  const diff = daysDiff(ts.nextDue); if (diff < 0) return 'overdue';
  const total = freqTotalDays(task.freq);
  const soonDays = total <= 7 ? 3 : total <= 60 ? 7 : total <= 180 ? 14 : 30;
  return diff <= soonDays ? 'due-soon' : 'ok';
}

function buildFreqCode(type, amount) { return amount + type; }

function freqCodeToLabel(freq) {
  const m = freq.match(/^(\d+)(d|w|mo|y)$/);
  if (!m) return freq;
  const n = m[1], t = m[2];
  if (t==='d') return n+' Day'+(n==='1'?'':'s');
  if (t==='w') return n+' Week'+(n==='1'?'':'s');
  if (t==='mo') return n+' Month'+(n==='1'?'':'s');
  if (t==='y') return n+' Year'+(n==='1'?'':'s');
  return freq;
}

function getTaskNote(taskId) { return getNotes()[taskId] || ''; }

// ‚îÄ‚îÄ Machine Selector ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderMachineSelector() {
  const sel = document.getElementById('machineSelect');
  sel.innerHTML = allData.machines.map(m =>
    `<option value="${m.id}" ${m.id === allData.activeMachine ? 'selected' : ''}>${esc(m.name)}</option>`
  ).join('');
}

function switchMachine() {
  allData.activeMachine = document.getElementById('machineSelect').value;
  saveAllData();
  renderAll();
}

// ‚îÄ‚îÄ Machine Management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openMachineModal(editId) {
  document.getElementById('machineEditId').value = editId || '';
  if (editId) {
    const m = allData.machines.find(m => m.id === editId);
    document.getElementById('machineModalTitle').textContent = 'EDIT MACHINE';
    document.getElementById('machineNameInput').value = m ? m.name : '';
  } else {
    document.getElementById('machineModalTitle').textContent = 'ADD MACHINE';
    document.getElementById('machineNameInput').value = '';
  }
  document.getElementById('machineModalOverlay').style.display = 'flex';
  setTimeout(() => document.getElementById('machineNameInput').focus(), 100);
}

function closeMachineModal() {
  document.getElementById('machineModalOverlay').style.display = 'none';
}

function saveMachine() {
  const name = document.getElementById('machineNameInput').value.trim();
  if (!name) { showToast('Please enter a machine name', 'error'); return; }
  const editId = document.getElementById('machineEditId').value;
  if (editId) {
    const m = allData.machines.find(m => m.id === editId);
    if (m) m.name = name;
    showToast('‚úì Machine renamed', 'success');
  } else {
    const newId = 'mach_' + Date.now();
    allData.machines.push({ id: newId, name });
    allData.machineData[newId] = { state: {}, notes: {}, custom: [] };
    allData.activeMachine = newId;
    showToast('‚úì Machine added ‚Äî now viewing ' + name, 'success');
  }
  saveAllData();
  closeMachineModal();
  renderMachineSelector();
  renderAll();
  autoSave();
}

function deleteMachine(machId) {
  if (allData.machines.length <= 1) { showToast('Cannot delete the only machine', 'error'); return; }
  const m = allData.machines.find(m => m.id === machId);
  if (!confirm('Delete "' + (m ? m.name : 'this machine') + '" and all its PM data? This cannot be undone.')) return;
  allData.machines = allData.machines.filter(m => m.id !== machId);
  delete allData.machineData[machId];
  if (allData.activeMachine === machId) allData.activeMachine = allData.machines[0].id;
  saveAllData();
  renderMachineSelector();
  renderAll();
  showToast('Machine deleted', 'success');
  autoSave();
}

// ‚îÄ‚îÄ Rendering ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAll() {
  updateStats();
  renderMachineSelector();
  document.getElementById('taskList').style.display = 'none';
  document.getElementById('historyList').style.display = 'none';
  document.getElementById('dataPanel').style.display = 'none';
  document.getElementById('managePanel').style.display = 'none';
  document.getElementById('techFilterBar').style.display = 'none';
  if (currentTab === 'history') { renderHistory(); return; }
  if (currentTab === 'data') { document.getElementById('dataPanel').style.display = 'block'; return; }
  if (currentTab === 'manage') { document.getElementById('managePanel').style.display = 'block'; renderManagePanel(); return; }

  const state = getState();
  const taskList = document.getElementById('taskList');
  taskList.style.display = '';
  let tasks = getAllTasks();
  if (currentTab === 'overdue') tasks = tasks.filter(t => getStatus(t) === 'overdue');
  else if (currentTab === 'due-soon') tasks = tasks.filter(t => getStatus(t) === 'due-soon');
  else if (currentTab === 'ok') tasks = tasks.filter(t => getStatus(t) === 'ok');
  else if (currentTab === 'pending') tasks = tasks.filter(t => getStatus(t) === 'pending');

  if (currentTab === 'by-date' || currentTab === 'all-sorted') {
    // Sort by soonest due date; pending (never done) goes to bottom
    tasks.sort((a, b) => {
      const aDate = state[a.id]?.nextDue || null;
      const bDate = state[b.id]?.nextDue || null;
      if (!aDate && !bDate) return 0;
      if (!aDate) return 1;
      if (!bDate) return -1;
      return aDate.localeCompare(bDate);
    });
  } else {
    const so = { overdue: 0, 'due-soon': 1, ok: 2, pending: 3 };
    tasks.sort((a, b) => {
      const d = so[getStatus(a)] - so[getStatus(b)]; if (d !== 0) return d;
      return (state[a.id]?.nextDue || '9999-99-99').localeCompare(state[b.id]?.nextDue || '9999-99-99');
    });
  }

  if (tasks.length === 0) { taskList.innerHTML = '<div class="empty-state">‚úì No tasks in this category</div>'; return; }
  taskList.innerHTML = '';
  let lastFreq = null, lastDivDate = null;

  tasks.forEach(task => {
    if (currentTab === 'all' && task.freqLabel !== lastFreq) {
      lastFreq = task.freqLabel;
      const div = document.createElement('div'); div.className = 'freq-divider'; div.textContent = '‚Äî ' + task.freqLabel + ' ‚Äî'; taskList.appendChild(div);
    }
    if (currentTab === 'by-date' || currentTab === 'all-sorted') {
      const lbl = state[task.id]?.nextDue ? formatDate(state[task.id].nextDue) : 'Never Completed';
      if (lbl !== lastDivDate) { lastDivDate = lbl; const div = document.createElement('div'); div.className = 'freq-divider'; div.textContent = '‚Äî ' + lbl + ' ‚Äî'; taskList.appendChild(div); }
    }

    const status = getStatus(task); const ts = state[task.id]; const histCount = ts?.history?.length || 0;
    const lastTech = ts?.history?.length ? ts.history[ts.history.length-1].tech : '';
    const taskNote = getTaskNote(task.id);
    let dueText = '', dueClass = '', tagHtml = '';
    if (status === 'pending') { dueText = 'Never completed ‚Äî needs initial service'; dueClass = 'orange'; tagHtml = '<span class="task-status-tag tag-pending">PENDING</span>'; }
    else {
      const diff = daysDiff(ts.nextDue);
      if (status === 'overdue') {
        dueText = `OVERDUE by ${Math.abs(diff)} day${Math.abs(diff)===1?'':'s'} ‚Äî was due ${formatDate(ts.nextDue)}`;
        dueClass = 'red';
        tagHtml = '<span class="task-status-tag tag-overdue">OVERDUE</span>';
      }
      else if (status === 'due-soon') { dueText = diff === 0 ? `Due TODAY ‚Äî ${formatDate(ts.nextDue)}` : `${formatDate(ts.nextDue)} <span style="font-weight:700;font-size:1.1rem;">(Due in ${diff} day${diff===1?'':'s'})</span>`; dueClass = 'yellow'; tagHtml = '<span class="task-status-tag tag-soon">DUE SOON</span>'; }
      else { dueText = `${formatDate(ts.nextDue)} <span style="font-weight:700;font-size:1.1rem;">(Due in ${diff} day${diff===1?'':'s'})</span>`; dueClass = 'green'; tagHtml = '<span class="task-status-tag tag-ok">ON TRACK</span>'; }
    }

    const ablogOverdue = status === 'overdue' ? `<div style="margin-top:8px;background:var(--red-dim);border:1px solid var(--red);padding:8px 10px;font-family:var(--font-mono);font-size:0.92rem;color:var(--red);line-height:1.5;">üö® Document in the Ablog immediately per NAL policy and complete PM ASAP.</div>` : '';
    const ablogSoon = (status === 'due-soon' && daysDiff(ts?.nextDue) <= 2) ? `<div style="margin-top:8px;background:var(--yellow-dim);border:1px solid var(--yellow);padding:6px 10px;font-family:var(--font-mono);font-size:0.88rem;color:var(--yellow);line-height:1.5;">‚ö† Due within 2 days ‚Äî if not completed on time, document in the Ablog per NAL policy.</div>` : '';

    const lastEntry = ts?.history?.length ? ts.history[ts.history.length-1] : null;
    const lastCompletedDate = lastEntry ? `Last completed: ${formatDate(lastEntry.date)}` : '';
    const lastCompletionNotes = lastEntry?.notes ? lastEntry.notes : '';

    const card = document.createElement('div');
    card.className = `task-card ${status === 'pending' ? 'never-done' : status}`;

    if (currentTab === 'all-sorted') {
      // Compact view ‚Äî name, due date, days remaining only
      let compactDue = '';
      if (status === 'pending') {
        compactDue = `<span style="color:var(--orange);">Never completed</span>`;
      } else if (status === 'overdue') {
        compactDue = `<span style="color:var(--red);font-weight:700;">Overdue by ${Math.abs(diff)} day${Math.abs(diff)===1?'':'s'}</span> <span style="color:var(--text-dim);font-size:0.9rem;">‚Äî was due ${formatDate(ts.nextDue)}</span>`;
      } else if (diff === 0) {
        compactDue = `<span style="color:var(--yellow);font-weight:700;">Due TODAY</span> <span style="color:var(--text-dim);font-size:0.9rem;">‚Äî ${formatDate(ts.nextDue)}</span>`;
      } else {
        compactDue = `<span style="color:var(--${dueClass === 'yellow' ? 'yellow' : 'green'});">${formatDate(ts.nextDue)}</span> <span style="font-weight:700;font-size:1.05rem;color:var(--${dueClass === 'yellow' ? 'yellow' : 'green'});">(Due in ${diff} day${diff===1?'':'s'})</span>`;
      }
      card.innerHTML = `<div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
        <div style="font-family:var(--font-display);font-size:1.1rem;font-weight:600;flex:1;">${esc(task.name)}</div>
      </div>
      <div style="font-family:var(--font-mono);font-size:0.95rem;margin-top:5px;">${compactDue}</div>`;
    } else {
      card.innerHTML = `<div class="task-top"><div class="task-name">${esc(task.name)}</div><div class="task-freq">${esc(task.freqLabel)}</div></div><div class="task-bottom"><div>${lastCompletedDate ? `<div class="history-count">${lastCompletedDate}</div>` : ''}${lastTech ? `<div class="last-tech">Tech: ${esc(lastTech)}</div>` : ''}<div class="task-due ${dueClass}">${dueText}</div>${taskNote ? `<div class="task-note-badge">üìå ${esc(taskNote)}</div>` : ''}</div>${tagHtml}</div>${ablogOverdue}${ablogSoon}${lastCompletionNotes ? `<div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border);font-family:var(--font-mono);font-size:0.85rem;color:var(--text-mid);"><span style="color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;font-size:0.75rem;">Notes: </span>${esc(lastCompletionNotes)}</div>` : ''}`;
    }    card.onclick = () => openModal(task.id);
    taskList.appendChild(card);
  });
}

function renderHistory() {
  const state = getState();
  const hl = document.getElementById('historyList'); hl.style.display = '';
  document.getElementById('techFilterBar').style.display = 'flex';
  const techSet = new Set();
  getAllTasks().forEach(task => { const ts = state[task.id]; if (ts?.history) ts.history.forEach(h => { if (h.tech) techSet.add(h.tech); }); });
  const sel = document.getElementById('techFilterSelect');
  const currentFilter = sel.value;
  sel.innerHTML = '<option value="">All Technicians</option>' + [...techSet].sort().map(t => `<option value="${t}" ${t===currentFilter?'selected':''}>${t}</option>`).join('');
  const filterTech = sel.value;
  let entries = [];
  getAllTasks().forEach(task => { const ts = state[task.id]; if (ts?.history) ts.history.forEach((h, idx) => { if (!filterTech || h.tech === filterTech) entries.push({ ...h, taskId: task.id, taskName: task.name, idx }); }); });
  entries.sort((a, b) => b.date.localeCompare(a.date));
  if (entries.length === 0) { hl.innerHTML = '<div class="empty-state">No completed tasks yet.</div>'; return; }
  hl.innerHTML = entries.map(e => `<div class="history-entry"><div style="display:flex;justify-content:space-between;align-items:flex-start;"><div><div class="history-date">‚úì ${formatDate(e.date)}</div><div class="history-tech" style="font-weight:600;color:var(--text);">${esc(e.taskName)}</div><div class="history-tech">Tech: ${esc(e.tech)||'Not specified'}</div>${e.notes?`<div class="history-notes">"${esc(e.notes)}"</div>`:''}</div><button class="history-edit-btn" onclick="openEditComp('${e.taskId}',${e.idx})">EDIT</button></div></div>`).join('');
}

function updateStats() {
  let overdue = 0, soon = 0, ok = 0, pending = 0;
  getAllTasks().forEach(t => { const s = getStatus(t); if (s==='overdue') overdue++; else if (s==='due-soon') soon++; else if (s==='ok') ok++; else pending++; });
  document.getElementById('stat-overdue').textContent = overdue;
  document.getElementById('stat-soon').textContent = soon;
  document.getElementById('stat-ok').textContent = ok;
  document.getElementById('stat-pending').textContent = pending;
  const badge = document.getElementById('globalOverdueBadge');
  if (overdue > 0) { badge.style.display = 'block'; badge.textContent = overdue + ' OVERDUE'; } else badge.style.display = 'none';
  const ob = document.getElementById('badge-overdue'); const sb = document.getElementById('badge-soon');
  if (overdue > 0) { ob.textContent = overdue; ob.style.display = 'inline'; } else ob.style.display = 'none';
  if (soon > 0) { sb.textContent = soon; sb.style.display = 'inline'; } else sb.style.display = 'none';
  document.title = overdue > 0 ? `(${overdue} OVERDUE) Mustang PM Tracker` : 'Mustang PM Tracker';
}

function setTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  const el = document.getElementById('tab-' + tab); if (el) el.classList.add('active');
  renderAll();
}

// ‚îÄ‚îÄ Task Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openModal(taskId) {
  currentTaskId = taskId;
  const task = getAllTasks().find(t => t.id === taskId);
  const state = getState();
  const ts = state[taskId];
  document.getElementById('modalTitle').textContent = task.name;
  document.getElementById('completionDate').value = today();
  document.getElementById('techName').value = localStorage.getItem('lastTechName') || '';
  document.getElementById('completionNotes').value = '';
  document.getElementById('modalInfo').innerHTML = `
    <div class="modal-info-row"><span class="info-label">Machine</span><span class="info-value">${esc(getActiveMachineName())}</span></div>
    <div class="modal-info-row"><span class="info-label">Frequency</span><span class="info-value">${esc(task.freqLabel)}</span></div>
    <div class="modal-info-row"><span class="info-label">Next Due</span><span class="info-value">${ts?.nextDue ? formatDate(ts.nextDue) : 'Never completed'}</span></div>
    <div class="modal-info-row"><span class="info-label">Status</span><span class="info-value">${{overdue:'üî¥ OVERDUE','due-soon':'üü° DUE SOON',ok:'üü¢ ON TRACK',pending:'üü† NEVER DONE'}[getStatus(task)]}</span></div>`;
  const history = ts?.history || [];
  const container = document.getElementById('historyEntries');
  if (history.length === 0) { container.innerHTML = '<div class="no-history">No history yet for this task.</div>'; }
  else { const sorted = [...history].sort((a,b) => b.date.localeCompare(a.date)); container.innerHTML = sorted.map(h => `<div class="history-entry"><div class="history-date">‚úì ${formatDate(h.date)}</div><div class="history-tech">Tech: ${esc(h.tech)||'Not specified'}</div>${h.notes?`<div class="history-notes">"${esc(h.notes)}"</div>`:''}</div>`).join(''); }
  updateNextDuePreview();
  document.getElementById('completionDate').addEventListener('change', updateNextDuePreview);
  document.getElementById('modalOverlay').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function updateNextDuePreview() {
  const task = getAllTasks().find(t => t.id === currentTaskId);
  const dateVal = document.getElementById('completionDate').value; if (!dateVal) return;
  const preview = document.getElementById('nextDuePreview');
  preview.style.display = 'block'; preview.textContent = `‚Üí Next due will be set to: ${formatDate(calcNextDue(dateVal, task.freq))}`;
}

function closeModal() { document.getElementById('modalOverlay').classList.remove('open'); document.body.style.overflow = ''; currentTaskId = null; }
function handleOverlayClick(e) { if (e.target === document.getElementById('modalOverlay')) closeModal(); }

function logCompletion() {
  const task = getAllTasks().find(t => t.id === currentTaskId);
  const state = getState();
  const dateVal = document.getElementById('completionDate').value;
  const tech = document.getElementById('techName').value.trim();
  const notes = document.getElementById('completionNotes').value.trim();
  if (!dateVal) { alert('Please select a completion date.'); return; }
  const nextDue = calcNextDue(dateVal, task.freq);
  if (!state[currentTaskId]) state[currentTaskId] = { nextDue: null, history: [] };
  state[currentTaskId].nextDue = nextDue;
  state[currentTaskId].history.push({ date: dateVal, tech, notes });
  if (tech) localStorage.setItem('lastTechName', tech);
  saveAllData(); closeModal(); renderAll();
  showToast('‚úì Logged! Next due: ' + formatDate(nextDue), 'success');
  autoSave();
}

// ‚îÄ‚îÄ Custom PM Tasks ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updatePMPreview() {
  const type = document.getElementById('pmFreqType').value;
  const amount = document.getElementById('pmAmount').value || 1;
  const labels = {d:'days',w:'weeks',mo:'months',y:'years'};
  const extras = {w:' ('+amount*7+' days)',mo:'',y:'',d:''};
  document.getElementById('pmAmountLabel').textContent = 'How many '+labels[type]+'?';
  document.getElementById('pmPreview').textContent = '‚Üí Repeats every '+amount+' '+labels[type]+(extras[type]||'');
}

function openAddPMModal(taskId) {
  document.getElementById('pmEditId').value = taskId || '';
  document.getElementById('pmEditType').value = '';
  if (taskId) {
    // Check if it's a built-in task being edited
    const builtIn = TASKS_DEFAULT.find(t => t.id === taskId);
    if (builtIn) {
      document.getElementById('pmEditType').value = 'builtin';
      document.getElementById('addPMTitle').textContent = 'EDIT BUILT-IN TASK';
      document.getElementById('pmName').value = builtIn.name;
      // Parse built-in freq
      const freqMap = {'1w':['w','1'],'1m':['mo','1'],'2m':['mo','2'],'3m':['mo','3'],'6m':['mo','6'],'1y':['y','1']};
      const fm = freqMap[builtIn.freq];
      if (fm) { document.getElementById('pmFreqType').value = fm[0]; document.getElementById('pmAmount').value = fm[1]; }
    } else {
      const custom = getCustomTasks();
      const t = custom.find(t => t.id === taskId);
      document.getElementById('addPMTitle').textContent = 'EDIT PM TASK';
      document.getElementById('pmName').value = t ? t.name : '';
      if (t) {
        const m = t.freq.match(/^(\d+)(d|w|mo|y)$/);
        if (m) { document.getElementById('pmFreqType').value = m[2]; document.getElementById('pmAmount').value = m[1]; }
      }
    }
  } else {
    document.getElementById('addPMTitle').textContent = 'ADD NEW PM TASK';
    document.getElementById('pmName').value = '';
    document.getElementById('pmFreqType').value = 'd';
    document.getElementById('pmAmount').value = '30';
  }
  updatePMPreview();
  document.getElementById('addPMOverlay').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeAddPMModal() {
  document.getElementById('addPMOverlay').classList.remove('open');
  document.body.style.overflow = '';
}

function handleAddPMClick(e) { if (e.target === document.getElementById('addPMOverlay')) closeAddPMModal(); }

function saveCustomPM() {
  const name = document.getElementById('pmName').value.trim();
  if (!name) { showToast('Please enter a task name', 'error'); return; }
  const freq = buildFreqCode(document.getElementById('pmFreqType').value, document.getElementById('pmAmount').value || 1);
  const editId = document.getElementById('pmEditId').value;
  const editType = document.getElementById('pmEditType').value;
  const machData = getActiveMachineData();

  if (editType === 'builtin') {
    // Editing a built-in task: store override in custom with same id
    const builtInId = parseInt(editId);
    const existingOverride = machData.custom.findIndex(t => t.id === builtInId);
    const override = { id: builtInId, name, freq, freqLabel: freqCodeToLabel(freq), custom: true, overrideBuiltIn: true };
    if (existingOverride !== -1) {
      machData.custom[existingOverride] = override;
    } else {
      machData.custom.push(override);
    }
    showToast('‚úì Task updated', 'success');
  } else if (editId) {
    const idx = machData.custom.findIndex(t => t.id === editId);
    if (idx !== -1) machData.custom[idx] = { ...machData.custom[idx], name, freq, freqLabel: freqCodeToLabel(freq) };
    showToast('‚úì Task updated', 'success');
  } else {
    machData.custom.push({ id: 'c_' + Date.now(), name, freq, freqLabel: freqCodeToLabel(freq), custom: true });
    showToast('‚úì New PM task added', 'success');
  }
  saveAllData();
  closeAddPMModal();
  renderAll();
  autoSave();
}

function deleteTask(taskId) {
  const state = getState();
  const machData = getActiveMachineData();
  const builtIn = TASKS_DEFAULT.find(t => t.id === taskId);
  const taskName = builtIn ? builtIn.name : (machData.custom.find(t => t.id === taskId)?.name || 'this task');
  if (!confirm('Delete "' + taskName + '" and all its history?')) return;
  machData.custom = machData.custom.filter(t => t.id !== taskId);
  delete state[taskId];
  if (getNotes()[taskId]) delete getNotes()[taskId];
  saveAllData();
  renderAll();
  showToast('Task deleted', 'success');
  autoSave();
}

// ‚îÄ‚îÄ Manage Panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderManagePanel() {
  const machData = getActiveMachineData();
  document.getElementById('manageMachineName').textContent = getActiveMachineName();

  // Machine list
  const ml = document.getElementById('machineList');
  ml.innerHTML = allData.machines.map(m => {
    const isActive = m.id === allData.activeMachine;
    const taskCount = Object.keys(allData.machineData[m.id]?.state || {}).length;
    return `<div class="machine-item ${isActive ? 'active-machine' : ''}">
      <div class="machine-item-name">${esc(m.name)}${isActive ? ' <span style="color:var(--orange);font-size:0.8rem;">‚óè ACTIVE</span>' : ''}</div>
      <div class="custom-task-btns">
        ${!isActive ? `<button class="btn-edit" onclick="allData.activeMachine='${m.id}';saveAllData();renderMachineSelector();renderAll();">SELECT</button>` : ''}
        <button class="btn-edit" onclick="openMachineModal('${m.id}')">RENAME</button>
        <button class="btn-del" onclick="deleteMachine('${m.id}')">DEL</button>
      </div>
    </div>`;
  }).join('');

  // All tasks list (built-in + custom, all editable/deletable)
  const allTasks = getAllTasks();
  const tl = document.getElementById('allTaskList');
  // Merge: show built-in tasks (with overrides applied) + pure custom tasks
  const builtInIds = TASKS_DEFAULT.map(t => t.id);
  const overrides = machData.custom.filter(t => t.overrideBuiltIn);
  const overrideMap = {};
  overrides.forEach(o => overrideMap[o.id] = o);

  let taskItems = '';
  TASKS_DEFAULT.forEach(t => {
    const display = overrideMap[t.id] || t;
    const isOverridden = !!overrideMap[t.id];
    taskItems += `<div class="custom-task-item">
      <div class="custom-task-info">
        <div class="custom-task-name">${esc(display.name)}${!isOverridden ? '<span class="builtin-label">BUILT-IN</span>' : '<span class="builtin-label">MODIFIED</span>'}</div>
        <div class="custom-task-freq">Every ${esc(display.freqLabel || t.freqLabel)}</div>
      </div>
      <div class="custom-task-btns">
        <button class="btn-edit" onclick="openAddPMModal(${t.id})">EDIT</button>
        <button class="btn-del" onclick="deleteTask(${t.id})">DEL</button>
      </div>
    </div>`;
  });

  const pureCustom = machData.custom.filter(t => !t.overrideBuiltIn);
  pureCustom.forEach(t => {
    taskItems += `<div class="custom-task-item">
      <div class="custom-task-info">
        <div class="custom-task-name">${esc(t.name)}<span class="builtin-label">CUSTOM</span></div>
        <div class="custom-task-freq">Every ${esc(t.freqLabel)}</div>
      </div>
      <div class="custom-task-btns">
        <button class="btn-edit" onclick="openAddPMModal('${t.id}')">EDIT</button>
        <button class="btn-del" onclick="deleteTask('${t.id}')">DEL</button>
      </div>
    </div>`;
  });
  tl.innerHTML = taskItems;

  // Note task select
  const noteSelect = document.getElementById('noteTaskSelect');
  noteSelect.innerHTML = getAllTasks().map(t => `<option value="${t.id}">${esc(t.name)}</option>`).join('');
  loadTaskNote();
}

// Override getAllTasks to apply built-in overrides per machine
window.getAllTasks = function() {
  const machData = getActiveMachineData();
  const builtIns = getDefaultTasksForMachine(allData.activeMachine);
  const overrideMap = {};
  machData.custom.filter(t => t.overrideBuiltIn).forEach(o => overrideMap[o.id] = o);
  const mergedBuiltIns = builtIns.map(t => overrideMap[t.id] || t);
  const pureCustom = machData.custom.filter(t => !t.overrideBuiltIn);
  return [...mergedBuiltIns, ...pureCustom];
};
// Also make it accessible without window prefix
function getAllTasks() { return window.getAllTasks(); }

// ‚îÄ‚îÄ Task Notes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadTaskNote() {
  const sel = document.getElementById('noteTaskSelect');
  if (!sel || !sel.value) return;
  document.getElementById('noteTextarea').value = getTaskNote(sel.value);
}
function saveTaskNote() {
  const id = document.getElementById('noteTaskSelect').value;
  const text = document.getElementById('noteTextarea').value.trim();
  const notes = getNotes();
  if (text) notes[id] = text; else delete notes[id];
  saveAllData();
  renderAll();
  showToast(text ? '‚úì Note saved' : '‚úì Note removed', 'success');
  autoSave();
}

// ‚îÄ‚îÄ Edit Completion ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openEditComp(taskId, idx) {
  const state = getState();
  const ts = state[taskId];
  if (!ts?.history?.[idx]) return;
  const h = ts.history[idx];
  document.getElementById('editCompTaskId').value = taskId;
  document.getElementById('editCompIndex').value = idx;
  document.getElementById('editCompDate').value = h.date;
  document.getElementById('editCompTech').value = h.tech || '';
  document.getElementById('editCompNotes').value = h.notes || '';
  document.getElementById('editCompOverlay').classList.add('open');
  document.body.style.overflow = 'hidden';
}
function closeEditComp() {
  document.getElementById('editCompOverlay').classList.remove('open');
  document.body.style.overflow = '';
}
function saveEditComp() {
  const state = getState();
  const taskId = document.getElementById('editCompTaskId').value;
  const idx = parseInt(document.getElementById('editCompIndex').value);
  const date = document.getElementById('editCompDate').value;
  const tech = document.getElementById('editCompTech').value.trim();
  const notes = document.getElementById('editCompNotes').value.trim();
  if (!date) { showToast('Please select a date', 'error'); return; }
  state[taskId].history[idx] = { date, tech, notes };
  const sorted = [...state[taskId].history].sort((a,b) => b.date.localeCompare(a.date));
  const task = getAllTasks().find(t => String(t.id) === String(taskId));
  if (task) state[taskId].nextDue = calcNextDue(sorted[0].date, task.freq);
  saveAllData();
  closeEditComp();
  renderHistory();
  showToast('‚úì Completion updated', 'success');
  autoSave();
}

// ‚îÄ‚îÄ PDF Export ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportPDF() {
  const machineName = getActiveMachineName();
  const state = getState();
  let entries = [];
  getAllTasks().forEach(task => { const ts = state[task.id]; if (ts?.history) ts.history.forEach(h => entries.push({ ...h, taskName: task.name })); });
  entries.sort((a, b) => b.date.localeCompare(a.date));
  const rows = entries.map((e, i) => `<tr style="background:${i%2===0?'#fff':'#f9f9f9'}"><td style="padding:10px 8px;border-bottom:1px solid #ddd;vertical-align:top;font-size:0.95rem;">${formatDate(e.date)}</td><td style="padding:10px 8px;border-bottom:1px solid #ddd;vertical-align:top;font-size:0.95rem;">${esc(e.taskName)}</td><td style="padding:10px 8px;border-bottom:1px solid #ddd;vertical-align:top;font-size:0.95rem;">${esc(e.tech)||'‚Äî'}</td><td style="padding:10px 8px;border-bottom:1px solid #ddd;vertical-align:top;font-size:0.95rem;">${esc(e.notes)||'‚Äî'}</td></tr>`).join('');
  document.getElementById('pdfContent').innerHTML = `
    <div style="font-size:1.2rem;font-weight:bold;color:#e06010;margin-bottom:4px;">${esc(machineName)} ‚Äî PM Report</div>
    <div style="color:#555;font-size:0.9rem;margin-bottom:16px;">Generated: ${new Date().toLocaleDateString()} &nbsp;|&nbsp; ${entries.length} total completions</div>
    <table style="width:100%;border-collapse:collapse;">
      <thead><tr>
        <th style="background:#f97316;color:#000;padding:10px 8px;text-align:left;font-size:0.9rem;">Date</th>
        <th style="background:#f97316;color:#000;padding:10px 8px;text-align:left;font-size:0.9rem;">Task</th>
        <th style="background:#f97316;color:#000;padding:10px 8px;text-align:left;font-size:0.9rem;">Technician</th>
        <th style="background:#f97316;color:#000;padding:10px 8px;text-align:left;font-size:0.9rem;">Notes</th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
  document.getElementById('pdfOverlay').style.display = 'block';
  document.body.style.overflow = 'hidden';
}
function closePDFOverlay() {
  document.getElementById('pdfOverlay').style.display = 'none';
  document.body.style.overflow = '';
}

// ‚îÄ‚îÄ Firebase Cloud Sync ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const firebaseConfig = {
  apiKey: "AIzaSyDdRqSK-SsdU2eMGyCWQln04kDVaNmNu2k",
  authDomain: "pm-tracker-testing.firebaseapp.com",
  projectId: "pm-tracker-testing",
  storageBucket: "pm-tracker-testing.firebasestorage.app",
  messagingSenderId: "676673476156",
  appId: "1:676673476156:web:e809863a797a0844461539"
};

let _db = null;
let _firebaseReady = false;

function initFirebase() {
  try {
    firebase.initializeApp(firebaseConfig);
    _db = firebase.firestore();
    _firebaseReady = true;
    setSyncStatus('synced', 'READY');
  } catch(e) {
    setSyncStatus('error', 'DB ERROR');
    console.error('Firebase init error:', e);
  }
}

// ‚îÄ‚îÄ Cloud Sync ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function cloudSave() {
  if (!_firebaseReady) { showToast('Database not ready', 'error'); return; }
  setSyncStatus('syncing', 'SAVING...');
  try {
    await _db.collection('devices').doc(deviceId).set({
      allData: JSON.stringify(allData),
      updatedAt: new Date().toISOString()
    });
    setSyncStatus('synced', 'SAVED ‚úì');
    showToast('‚úì Saved to cloud', 'success');
  } catch(e) {
    setSyncStatus('error', 'ERROR');
    showToast('Save failed: ' + e.message, 'error');
  }
}

async function cloudLoad() {
  if (!_firebaseReady) { showToast('Database not ready', 'error'); return; }
  setSyncStatus('syncing', 'LOADING...');
  try {
    const snap = await _db.collection('devices').doc(deviceId).get();
    if (!snap.exists) { showToast('No cloud data found for: ' + deviceId, 'error'); setSyncStatus('offline', 'NO DATA'); return; }
    const d = snap.data();
    if (d.allData) {
      allData = JSON.parse(d.allData);
    } else if (d.state) {
      // Legacy single-machine format migration
      allData = {
        machines: [{ id: 'default', name: d.machineName || 'Mustang' }],
        activeMachine: 'default',
        machineData: { 'default': { state: JSON.parse(d.state), notes: d.notes ? JSON.parse(d.notes) : {}, custom: d.custom ? JSON.parse(d.custom) : [] } }
      };
    } else {
      showToast('No valid data found', 'error'); setSyncStatus('offline', 'NO DATA'); return;
    }
    saveAllData();
    setSyncStatus('synced', 'LOADED ‚úì');
    showToast('‚úì Data loaded from cloud', 'success');
    renderAll();
  } catch(e) {
    setSyncStatus('error', 'ERROR');
    showToast('Load failed: ' + e.message, 'error');
  }
}

async function autoSave() {
  if (!_firebaseReady) return;
  if (!deviceId) return;
  await cloudSave();
}

// ‚îÄ‚îÄ Export / Import ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportData() {
  const blob = new Blob([JSON.stringify({ deviceId, exportedAt: new Date().toISOString(), allData }, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `mustang-pm-backup-${deviceId||'device'}-${today()}.json`; a.click();
  URL.revokeObjectURL(url);
  showToast('‚úì Backup file downloaded', 'success');
}

function importData(event) {
  const file = event.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = JSON.parse(e.target.result);
      if (data.allData) {
        allData = data.allData; saveAllData();
        showToast('‚úì All machines restored from backup', 'success');
      } else if (data.state) {
        // Legacy single-machine import
        const id = allData.activeMachine;
        allData.machineData[id].state = data.state;
        saveAllData();
        showToast('‚úì Data restored (legacy format)', 'success');
      } else {
        showToast('Invalid backup file', 'error'); return;
      }
      renderAll();
    } catch(err) { showToast('Failed to read file', 'error'); }
  };
  reader.readAsText(file); event.target.value = '';
}

// ‚îÄ‚îÄ Settings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleLightMode() {
  const isLight = document.body.classList.toggle('light-mode');
  localStorage.setItem('mustangpm_lightmode', isLight ? '1' : '0');
  document.getElementById('lightToggleBtn').textContent = isLight ? 'üåô' : '‚òÄ';
}

const _fontSizes = ['normal', 'lg', 'xl'];
let _currentFont = localStorage.getItem('mustangpm_fontsize') || 'normal';
function applyFontSize(s) {
  document.documentElement.style.fontSize = s==='xl' ? '20px' : s==='lg' ? '17px' : '15px';
  const btn = document.getElementById('fontSizeBtn');
  btn.textContent = s==='xl' ? 'A++' : s==='lg' ? 'A+' : 'A';
  btn.style.fontSize = s==='xl' ? '0.75rem' : s==='lg' ? '0.9rem' : '1.2rem';
  _currentFont = s; localStorage.setItem('mustangpm_fontsize', s);
}
function cycleFontSize() { applyFontSize(_fontSizes[(_fontSizes.indexOf(_currentFont)+1)%_fontSizes.length]); }

function shareApp() {
  const url = 'https://nlt42886.github.io/PM-Tracker';
  if (navigator.share) {
    navigator.share({ title: 'Mustang PM Tracker', url });
  } else {
    navigator.clipboard.writeText(url).then(() => {
      showToast('‚úì Link copied to clipboard!', 'success');
    }).catch(() => { showToast('Link: ' + url, ''); });
  }
}

function checkForUpdate() {
  const btn = document.getElementById('updateBtn');
  btn.textContent = '‚Üª'; btn.style.color = 'var(--yellow)'; btn.style.borderColor = 'var(--yellow)';
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistration().then(reg => {
      if (!reg) { showToast('Pull down to refresh for latest version', ''); resetUpdateBtn(); return; }
      reg.update().then(() => {
        const waiting = reg.waiting;
        if (waiting) { waiting.postMessage({ type: 'SKIP_WAITING' }); showToast('‚úì Update found! Pull down to refresh.', 'success'); setTimeout(() => window.location.reload(), 1500); }
        else { showToast('‚úì Check complete ‚Äî pull down to refresh.', 'success'); resetUpdateBtn(); }
      });
    });
  } else { showToast('‚úì Check complete ‚Äî pull down to refresh.', 'success'); resetUpdateBtn(); }
}
function resetUpdateBtn() { const btn = document.getElementById('updateBtn'); btn.textContent = '‚Üª'; btn.style.color = ''; btn.style.borderColor = ''; }

function showInstallPrompt() {
  if (localStorage.getItem('mustangpm_installprompt') === 'dismissed') return;
  if (window.matchMedia('(display-mode: standalone)').matches) return;
  document.getElementById('installPrompt').style.display = 'flex';
}
function dismissInstallPrompt() {
  localStorage.setItem('mustangpm_installprompt', 'dismissed');
  document.getElementById('installPrompt').style.display = 'none';
}

// ‚îÄ‚îÄ Global Exports ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.setTab = setTab;
window.switchMachine = switchMachine;
window.openMachineModal = openMachineModal;
window.closeMachineModal = closeMachineModal;
window.saveMachine = saveMachine;
window.deleteMachine = deleteMachine;
window.cloudSave = cloudSave;
window.cloudLoad = cloudLoad;
window.openPinModal = openPinModal;
window.closePinModal = closePinModal;
window.confirmSetPin = confirmSetPin;
window.confirmLoadPin = confirmLoadPin;
window.exportData = exportData;
window.importData = importData;
window.openModal = openModal;
window.closeModal = closeModal;
window.handleOverlayClick = handleOverlayClick;
window.logCompletion = logCompletion;
window.openAddPMModal = openAddPMModal;
window.closeAddPMModal = closeAddPMModal;
window.handleAddPMClick = handleAddPMClick;
window.saveCustomPM = saveCustomPM;
window.deleteTask = deleteTask;
window.updatePMPreview = updatePMPreview;
window.toggleLightMode = toggleLightMode;
window.cycleFontSize = cycleFontSize;
window.loadTaskNote = loadTaskNote;
window.saveTaskNote = saveTaskNote;
window.openEditComp = openEditComp;
window.closeEditComp = closeEditComp;
window.saveEditComp = saveEditComp;
window.exportPDF = exportPDF;
window.closePDFOverlay = closePDFOverlay;
window.shareApp = shareApp;
window.checkForUpdate = checkForUpdate;
window.dismissInstallPrompt = dismissInstallPrompt;

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('completionDate').value = today();
if (localStorage.getItem('mustangpm_lightmode') === '1') {
  document.body.classList.add('light-mode');
  document.getElementById('lightToggleBtn').textContent = 'üåô';
}
applyFontSize(_currentFont);
setSyncStatus('offline', 'OFFLINE');
initFirebase();
renderAll();
setTimeout(() => showInstallPrompt(), 3000);
</script>
</body>
</html>
